<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>EventMachine</title>

<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<link rel="stylesheet" href="s5/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="s5/outline.css" type="text/css" media="screen" id="outlineStyle" />
<script src="s5/slides.js" type="text/javascript"></script>

<script src="highlight/highlight.js" type="text/javascript"></script>
<script src="highlight/languages/ruby.js" type="text/javascript"></script>
<script type="text/javascript">
hljs.initHighlightingOnLoad();
</script>
</head>

<body>
<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>

<div id="header"></div>
<div id="footer">
  <a href="https://github.com/norbert/presentations/tree/rubyenrails2009">github.com/norbert/presentations<br>/tree/rubyenrails2009</a>
</div>
</div>

<div class="presentation">
<div class="slide">
<h1>EventMachine</h1>
<h2>Norbert Crombach</h2>
</div>

<!--
<div class="slide">
  <pre><code class="ruby">
  </code></pre>
</div>
-->

<div class="caption slide">
<h2>Slides on GitHub</h2>
</div>

<div class="caption slide">
<h2>Laptop recommended</h2>
</div>

<div class="caption slide">
<h2><code>gem install eventmachine</code></h2>
</div>

<div class="caption slide">
<h1>Who?</h1>
</div>

<div class="caption slide">
<h1>What?</h1>
</div>

<div class="caption slide">
<h2>Asynchronous event handling</h2>
</div>

<div class="caption slide">
<h1>Why?</h1>
</div>

<div class="caption slide">
<h2>Raw speed</h2>
</div>

<div class="caption slide">
<h2>Better code</h2>
</div>

<div class="caption slide">
<h1>Basics</h1>
</div>

<div class="caption slide">
<h2>Reactor pattern</h2>
</div>

<div class="caption slide">
<h2>Event loop</h2>
</div>

<div class="caption slide">
<h2>Callbacks</h2>
</div>

<div class="example slide">
<h2>Running</h2>
<pre><code class="ruby">
require 'eventmachine'

<span class="constant">EventMachine</span>.<em>run</em> {
  puts EM.<em>reactor_running?</em> # =&gt; true
  EM.<em>stop</em>
}
</code></pre>
</div>

<div class="example slide">
<h2>Timers</h2>
<pre><code class="ruby">
require 'eventmachine'

EM.run {
  EM.<em>add_timer</em>(3) {
    EM.stop
  }

  EM.<em>add_periodic_timer</em>(1) {
    puts true # runs twice
  }
}
</code></pre>
</div>

<div class="example slide">
<h2>Scheduling</h2>
<pre><code class="ruby">
require 'eventmachine'

EM.run {
  EM.<em>next_tick</em> {
    # runs on next reactor turn
  }

  operation = lambda {
    # runs on separate thread
  }
  callback = lambda {
    # runs when operation completes
  }
  EM.<em>defer</em>(operation, callback)
}
</code></pre>
</div>

<div class="example slide">
<h2>Connecting</h2>
<pre><code class="ruby">
require 'eventmachine'

module HttpClient
  def <em>post_init</em>
    send_data "GET / HTTP/1.1\r\n\r\n"
  end

  def <em>receive_data</em>(data)
    puts data
    close_connection_after_writing
  end
end

EM.run {
  <em>EM.connect</em> "www.google.com", 80, <em>HttpClient</em>
}
</code></pre>
</div>

<div class="example slide">
<h2>Deferrable</h2>
<pre><code class="ruby">
require 'eventmachine'

class DeferrableOperation
  include <em>EM::Deferrable</em>
end

EM.run {
  operation = DeferrableOperation.new

  operation.<em>callback</em> {
    puts true
  }
  operation.<em>errback</em> {
    puts false
  }

  EM.add_timer(1) {
    operation.set_deferred_status :succeeded
  }
}
</code></pre>
</div>

<div class="caption slide">
<h1>Features</h1>
</div>

<div class="caption slide">
<h1>Networking</h1>
</div>

<div class="example slide">
<h2>Blocking</h2>
<pre><code class="ruby">
require 'socket'
server = <span class="constant">TCPServer</span>.new("0.0.0.0", 8080)

<em>loop</em> do
  connection = server.accept
  request = connection.read
  # handle request
  connection.write response
  connection.close
end
</code></pre>
</div>

<div class="example slide">
<h2>Forking</h2>
<pre><code class="ruby">
require 'socket'
server = TCPServer.new("0.0.0.0", 8080)

<em>loop</em> do
  connection = server.accept
  if <em>fork</em>
    # handle request
    connection.close
  end
end
</code></pre>
</div>

<div class="example slide">
<h2>Pre-forking</h2>
<pre><code class="ruby">
require 'socket'
server = TCPServer.new("0.0.0.0", 8080)

(workers - 1).times do
  break unless <em>fork</em>
end

loop do
  connection = server.accept
  # handle request
  connection.close
end
</code></pre>
</div>

<div class="dual example slide">
<h2>Threading</h2>
<pre><code class="ruby">
require 'socket'
server = TCPServer.new # ...

require 'thread'

loop do
  connection = server.accept
  <em>Thread.new</em> do
    # handle request
    connection.close
  end
end
</code></pre>
<pre><code class="ruby">
require 'socket'
server = TCPServer.new # ...

require 'thread'

def start
  loop do
    connection = server.accept
    # handle request
    connection.close
  end
end

(workers - 1).times do
  <em>Thread.new</em> { start }
end

start
</code></pre>
</div>

<div class="example slide">
<h2>Thread pooling</h2>
<pre><code class="ruby">
require 'socket'
server = TCPServer.new("0.0.0.0", 8080)

require 'thread'

queue = <span class="constant">Queue</span>.new

workers.times do
  <em>Thread.new</em> do
    loop do
      if connection = <em>queue.shift</em>
        # handle request
        connection.close
      end
    end
  end
end

loop do
  <em>queue.push server.accept</em>
end
</code></pre>
</div>

<div class="dual example slide">
<h2>EventMachine</h2>
<pre><code class="ruby">
require 'eventmachine'

module HttpServer
  def <em>receive_data</em>(data)
    # handle request
    send_data response
  end
end

EventMachine.run {
  <em>EM.start_server</em> "0.0.0.0", 8080, <em>HttpServer</em>
}
</code></pre>
<pre><code class="ruby">
require 'eventmachine'

class HttpServer &lt; <em>EM::Connection</em>
  def receive_data(data)
    # handle request
    send_data response
  end
end
</code></pre>
</div>

<div class="caption slide">
<h1>Performance</h1>
</div>

<div class="caption slide">
<h2>Context switching</h2>
</div>

<div class="caption slide">
<h2>select, epoll and kqueue</h2>
</div>

<div class="caption slide">
<h2>O(n) v. O(1)</h2>
</div>

<div class="caption slide">
<h2>Server performance</h2>
</div>

<div class="caption slide">
<h2>Client performance</h2>
</div>

<div class="caption slide">
<h1>Questions?</h1>
</div>

<div class="caption slide">
<h1><code>EM.stop</code></h1>
</div>
</div>
</div>
</body>
</html>
